<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–∞–ª–∞–Ω—Å</title>
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800;900&family=Pixelify+Sans:wght@400..700&display=swap"
        rel="stylesheet">
</head>

<body style="height: 100%; overflow-y: hidden;">
    <div class="container_card">

        <!-- <pre id="tg-data"
            style="white-space: pre-wrap; word-wrap: break-word; background: #f5f5f5; padding: 10px; border: 1px solid #ccc;"></pre> -->

        <h1 class="title">–°–¥–µ–ª–∞—Ç—å –∑–¥–æ—Ä–æ–≤—ã–π –ø–µ—Ä–µ–∫—É—Å</h1>

        <div class="medium">–°–¥–µ–ª–∞—Ç—å –∑–¥–æ—Ä–æ–≤—ã–π –ø–µ—Ä–µ–∫—É—Å: –æ—Ä–µ—Ö–∏, —Ñ—Ä—É–∫—Ç—ã(–±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ), –æ–≤–æ—â–∏, –π–æ–≥—É—Ä—Ç, —Ç–≤–æ—Ä–æ–≥, —è–≥–æ–¥—ã, —Å—É—Ö–æ—Ñ—Ä—É–∫—Ç—ã, —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã–µ —Ö–ª–µ–±—Ü—ã, —Å–º—É–∑–∏</div>

        <div class="coins-wrap">
            <div class="plus-text">
                +500
            </div>
            <div class="coins coin-img">
                <img style="z-index: 3" src="coin/sportcoin.avif" alt="–ú–æ–Ω–µ—Ç–∞">
                <img style="z-index: 2" src="coin/sportcoin.avif" alt="–ú–æ–Ω–µ—Ç–∞">
                <img style="z-index: 1" src="coin/sportcoin.avif" alt="–ú–æ–Ω–µ—Ç–∞">
            </div>
        </div>

        <div class="photo-upload" onclick="document.getElementById('fileInput').click()">
            <input type="file" name="file" id="fileInput" style="display: none;" onchange="updateFileName(this)">
            <span class="input-file-btn" id="fileLabel">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</span>
        </div>


        <a href="#" class="btn">
            –í—ã–ø–æ–ª–Ω–µ–Ω–æ
        </a>

        <div id="loadingOverlay" style="display: none;">
            <!-- <div id="loadingOverlay"> -->
            <div class="loader-container">
                <img src="dog_loader.gif" alt="–ó–∞–≥—Ä—É–∑–∫–∞..." class="loader" />
            </div>
        </div>
    </div>

    <body>
        <script>
            function updateFileName(input) {
                const fileLabel = document.getElementById('fileLabel');
                if (input.files && input.files[0]) {
                    fileLabel.textContent = input.files[0].name;
                }
            }

            const tg_app = window.Telegram.WebApp

            tg_app.setHeaderColor('#FFFFFF')
            tg_app.setBackgroundColor('#FFFFFF')
            tg_app.setBottomBarColor('#FFFFFF')
            document.addEventListener("DOMContentLoaded", function () {

                const backButton = tg_app.BackButton;
                backButton.show()
                backButton.onClick(() => {
                    // backButton.hide();

                    window.location.href = "/crasavacoin_app/sportcoin/index.html";
                });

                const current_user = {
                    id: tg_app.initDataUnsafe.user.id,
                    name: tg_app.initDataUnsafe.user.first_name,
                    photo_url: tg_app.initDataUnsafe.user.photo_url,
                };

                const safe_area_data = {
                    safeAreaInset: tg_app.safeAreaInset,
                    contentSafeAreaInset: tg_app.contentSafeAreaInset
                };

                const button = document.querySelector('.btn');
                const overlay = document.getElementById('loadingOverlay');

                function compressImageToBase64(file, options = {}) {
                    const { maxWidth = 1024, maxHeight = 1024, mimeType = 'image/jpeg', quality = 0.7 } = options;
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onerror = () => reject(new Error());
                        reader.onload = () => {
                            const dataUrl = reader.result;
                            if (typeof dataUrl !== 'string' || !dataUrl.includes(',')) return reject(new Error());
                            const img = new Image();
                            img.onerror = () => reject(new Error());
                            img.onload = () => {
                                let w = img.width;
                                let h = img.height;
                                if (w > maxWidth || h > maxHeight) {
                                    const ratio = Math.min(maxWidth / w, maxHeight / h);
                                    w = Math.round(w * ratio);
                                    h = Math.round(h * ratio);
                                }
                                const canvas = document.createElement('canvas');
                                canvas.width = w;
                                canvas.height = h;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, w, h);
                                const compressed = canvas.toDataURL(mimeType, mimeType === 'image/jpeg' ? quality : undefined);
                                resolve(compressed.split(',')[1]);
                            };
                            img.src = dataUrl;
                        };
                        reader.readAsDataURL(file);
                    });
                }

                button.addEventListener('click', async (e) => {
                    e.preventDefault(); // —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑-–∑–∞ href="#"
                    button.textContent = '–ò–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞...';
                    overlay.style.display = 'flex';

                    if (button.disabled) return; // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π

                    button.disabled = true; // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É

                    const file = fileInput.files[0];
                    if (!file) {
                        alert('–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ');
                        button.disabled = false;
                        overlay.style.display = 'none';
                        button.textContent = '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
                        return;
                    }

                    let base64;
                    try {
                        // base64 = await readFileAsDataURL(file);
                        base64 = await compressImageToBase64(file);
                    } catch (e) {
                        alert(`Could not read file:\n${e.message}`);
                        button.disabled = false;
                        overlay.style.display = 'none';
                        button.textContent = '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
                        return;
                    }

                    try {
                        const res = await fetch(
                            'https://d5du1sjf5ctcjd49l11o.z7jmlavt.apigw.yandexcloud.net/tg-sport-send-report',
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ caption: `ü•ä –û—Ç–ª–∏—á–Ω—ã–π –∑–¥–æ—Ä–æ–≤—ã–π –ø–µ—Ä–µ–∫—É—Å, ${current_user.name} üëèüèª
+500 STC`, photo: base64 }),
                            }
                        );

                        if (res.ok) {
                            // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ, –≤—ã–ø–æ–ª–Ω—è–µ–º –≤—Ç–æ—Ä–æ–π
                            try {
                                const secondRes = await fetch('https://sportcoin-c6cf4-default-rtdb.europe-west1.firebasedatabase.app/tasks.json', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        'action': 4,
                                        'coins': 500,
                                        'user_id': current_user.id,
                                        'timestamp': Date.now()
                                    })
                                });

                                if (secondRes.ok) {
                                    // –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å —Ç–æ–∂–µ —É—Å–ø–µ—à–µ–Ω
                                    window.location.href = "/crasavacoin_app/sportcoin/index.html"; // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                                } else {
                                    alert(`Server error during coin update:\n${secondRes.status} ${secondRes.statusText}`);
                                    button.disabled = false;
                                    overlay.style.display = 'none';
                                    button.textContent = '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
                                }
                            } catch (error) {
                                console.error("Error in second request:", error);
                                alert(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –±–∞–ª–ª–æ–≤. ${error}`);
                                button.disabled = false;
                                overlay.style.display = 'none';
                                button.textContent = '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
                            }
                        } else {
                            alert(`–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–∞–π–ª–æ–º. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ:\n${res.status} ${res.statusText}`);
                            button.disabled = false;
                            overlay.style.display = 'none';
                            button.textContent = '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
                        }
                    } catch (e) {
                        alert(`–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–∞–π–ª–æ–º. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ:\n${e.message}`);
                        button.disabled = false;
                        overlay.style.display = 'none';
                        button.textContent = '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
                    }
                })
            });
        </script>

</html>